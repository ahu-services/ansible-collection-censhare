---
- name: Install Podman helper packages
  become: true
  ansible.builtin.dnf:
    name:
      - podman-docker
      - runc
    state: present

- name: Ensure /etc/containers exists
  become: true
  ansible.builtin.file:
    path: /etc/containers
    state: directory
    mode: '0755'

- name: Ensure quadlet directory exists
  become: true
  ansible.builtin.file:
    path: "{{ censhare_sclient_quadlet_dir }}"
    state: directory
    mode: '0755'

- name: Ensure iccprofiles directory exists
  become: true
  ansible.builtin.file:
    path: "{{ censhare_sclient_iccprofiles_dir }}"
    state: directory
    mode: '0755'

- name: Configure Podman to use runc as the default runtime
  become: true
  ansible.builtin.copy:
    dest: /etc/containers/containers.conf
    content: |
      [engine]
      runtime = "runc"
    mode: '0644'

- name: Remove legacy systemd unit files
  become: true
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - "/etc/systemd/system/{{ censhare_sclient_collabora_name }}.service"
    - "/etc/systemd/system/container-{{ censhare_sclient_svc_name }}.service"

- name: Reload systemd after removing legacy units
  become: true
  ansible.builtin.systemd:
    daemon_reload: true

- name: Detect SELinux enforcement
  ansible.builtin.set_fact:
    censhare_sclient_selinux_enforcing: "{{ (ansible_selinux is defined) and (ansible_selinux.status == 'enabled') and (ansible_selinux.mode == 'enforcing') }}"

- name: Persist SELinux context for ICC profiles directory
  when: censhare_sclient_selinux_enforcing | default(false)
  become: true
  community.general.sefcontext:
    target: "{{ censhare_sclient_iccprofiles_dir }}(/.*)?"
    setype: container_file_t
    state: present

- name: Apply SELinux context to ICC profiles directory
  when: censhare_sclient_selinux_enforcing | default(false)
  become: true
  ansible.builtin.command: "restorecon -Rv {{ censhare_sclient_iccprofiles_dir }}"
  register: censhare_sclient_restorecon
  changed_when: censhare_sclient_restorecon.stdout is search('Relabeled')

- name: Gather service facts for firewall detection
  become: true
  ansible.builtin.service_facts:

- name: Determine if firewalld is active
  ansible.builtin.set_fact:
    censhare_sclient_firewalld_active: >-
      {{
        'firewalld.service' in (ansible_facts.services | default({}))
        and ansible_facts.services['firewalld.service'].state == 'running'
      }}

- name: Ensure podman network for service-client exists
  become: true
  containers.podman.podman_network:
    name: "{{ censhare_sclient_container_network }}"
    state: present

- name: Pull the cs-image-tools image
  become: true
  containers.podman.podman_image:
    name: "{{ censhare_sclient_tools_image }}"
    tag: "{{ censhare_sclient_tools_version }}"
    state: present
  tags:
    - css_update

- name: Pull the collabora image
  become: true
  containers.podman.podman_image:
    name: "{{ censhare_sclient_collabora_image }}"
    tag: "{{ censhare_sclient_collabora_version }}"
    state: present
  tags:
    - css_update

- name: Install firewall bindings when firewalld is active
  become: true
  ansible.builtin.dnf:
    name: python3-firewall
    state: present
  when: censhare_sclient_firewalld_active | default(false)

- name: Define firewalld service for censhare service-client
  become: true
  ansible.builtin.copy:
    dest: "/etc/firewalld/services/{{ censhare_sclient_firewalld_service }}.xml"
    mode: '0644'
    content: |
      <?xml version="1.0" encoding="utf-8"?>
      <service>
        <short>{{ censhare_sclient_firewalld_service }}</short>
        <description>censhare Service Client callback port</description>
        <port protocol="tcp" port="{{ censhare_sclient_rmi_port }}"/>
      </service>
  when: censhare_sclient_firewalld_active | default(false)
  notify: Reload firewalld

- name: Apply firewalld changes before opening service
  ansible.builtin.meta: flush_handlers
  when: censhare_sclient_firewalld_active | default(false)

- name: Open service-client callback port in firewalld
  become: true
  ansible.posix.firewalld:
    service: "{{ censhare_sclient_firewalld_service }}"
    permanent: true
    state: enabled
    immediate: true
  when: censhare_sclient_firewalld_active | default(false)

- name: Configure collabora quadlet
  become: true
  containers.podman.podman_container:
    name: "{{ censhare_sclient_collabora_name }}"
    image: "{{ censhare_sclient_collabora_image }}:{{ censhare_sclient_collabora_version }}"
    state: quadlet
    quadlet_dir: "{{ censhare_sclient_quadlet_dir }}"
    quadlet_filename: "{{ censhare_sclient_collabora_name }}"
    network: "{{ censhare_sclient_container_network }}"
    publish:
      - "127.0.0.1:9980:9980"
    env:
      extra_params: "{{ censhare_sclient_collabora_extra_params }}"
    quadlet_options:
      - |
        [Install]
        WantedBy={{ censhare_sclient_quadlet_wanted_by }}
      - |
        [Unit]
        After=network-online.target
      - |
        [Service]
        Restart=always
        RestartSec=5
        TimeoutStopSec=70
  notify: Restart collabora quadlet
  tags:
    - css_update

- name: Ensure collabora quadlet service is enabled
  become: true
  ansible.builtin.systemd:
    name: "{{ censhare_sclient_collabora_service_unit }}"
    enabled: true
    state: started
    daemon_reload: true
  tags:
    - css_update

- name: Configure service-client quadlet
  become: true
  containers.podman.podman_container:
    name: "{{ censhare_sclient_svc_name }}"
    image: "{{ censhare_sclient_tools_image }}:{{ censhare_sclient_tools_version }}"
    state: quadlet
    quadlet_dir: "{{ censhare_sclient_quadlet_dir }}"
    quadlet_filename: "{{ censhare_sclient_svc_name }}"
    network: "{{ censhare_sclient_container_network }}"
    publish:
      - "{{ censhare_sclient_rmi_port }}:{{ censhare_sclient_rmi_port }}"
    env:
      REPO_USER: "{{ censhare_sclient_repo_user }}"
      REPO_PASS: "{{ censhare_sclient_repo_pass }}"
      VERSION: "{{ censhare_sclient_censhare_version }}"
      SVC_USER: "{{ censhare_sclient_svc_user }}"
      SVC_INSTANCES: "{{ censhare_sclient_instances | string }}"
      SVC_PASS: "{{ censhare_sclient_svc_pass }}"
      SVC_HOST: "{{ censhare_sclient_svc_host }}"
      OFFICE_URL: "{{ censhare_sclient_office_url }}"
      SERVICECLIENT_RMI_PORT: "{{ censhare_sclient_rmi_port | string }}"
      SERVICECLIENT_CALLBACK_HOST: "{{ censhare_sclient_callback_host }}"
      FFMPEG_TIMEOUT: "1800"
    volumes:
      - "{{ censhare_sclient_iccprofiles_dir }}:/iccprofiles{{ ':Z' if censhare_sclient_selinux_enforcing | default(false) else '' }}"
    quadlet_options:
      - |
        [Install]
        WantedBy={{ censhare_sclient_quadlet_wanted_by }}
      - |
        [Unit]
        After={{ censhare_sclient_collabora_service_unit }} network-online.target
      - |
        [Service]
        Restart=always
        RestartSec=5
        TimeoutStopSec=70
  notify: Restart service-client quadlet
  no_log: true
  tags:
    - css_update

- name: Ensure service-client quadlet service is enabled
  become: true
  ansible.builtin.systemd:
    name: "{{ censhare_sclient_service_unit }}"
    enabled: true
    state: started
    daemon_reload: true
  tags:
    - css_update
